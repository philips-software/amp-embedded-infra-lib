<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ECHO (Embedded CHOmmunication) :: Embedded Infrastructure Library</title>
    <link rel="canonical" href="https://philips-software.github.io/amp-embedded-infra-lib/embedded_infrastructure_library/5.0.1/Echo.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/centralesans.css">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/site-extra.css">
    <link rel="icon" href="../../favicon.svg" type="image/svg+xml">

    <link rel="stylesheet" href="../../_/css/site-extra.css">
    <link rel="stylesheet" href="../../_/css/centralesans.css">

      </head>
  <body class="article">
<header class="header" role="banner">
    <div class="header-top-row">
        <div class="container">
            <nav class="navbar">
                <div class="navbar-brand">
                    <a class="navbar-brand">
                        <img class="scale-down"  src="../../philips-logo.png" alt="Philips"/>
                    </a>
                    <a class="navbar-item" href="https://philips-software.github.io/amp-embedded-infra-lib">Embedded Infrastructure Library</a>
                    <button class="navbar-burger" data-target="topbar-nav">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
                <div id="topbar-nav" class="navbar-menu">
                    <div class="navbar-end">
                        <a class="navbar-item" href="https://github.com/philips-software/amp-embedded-infra-lib">
                            <span class="icon">
                                <svg aria-labelledby="simpleicons-github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <title id="simpleicons-github-icon">GitHub</title>
                                <path fill="#f5f5f5" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                            </span>
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</header>
<div class="body">
<main class="article">
<div class="toolbar toolbar-wrap">
  <div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Embedded Infrastructure Library documentation</a></li>
    <li><a href="Echo.html">Echo</a></li>
  </ul>
</nav>
      <div class="edit-this-page"><a href="https://github.com/philips-software/amp-embedded-infra-lib/edit/main/documents/modules/ROOT/pages/Echo.adoc">Edit this page</a></div>
      </div>
</div>
  <div class="content">
<div class="nav-container" data-component="embedded_infrastructure_library" data-version="5.0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Embedded Infrastructure Library documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ExecutionModel.html">Execution Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="MemoryRange.html">MemoryRange</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Containers.html">Containers</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="Echo.html">Echo</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="NetworkConnections.html">NetworkConnections</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CodingStandard.html">Coding Standard</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div></div>
    </div>
  </aside>
</div>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">ECHO (Embedded CHOmmunication)</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ECHO is the name of the embedded remote procedure call (RPC) mechanism
used in the Embedded Infrastructure Library. As an RPC mechanism, it
provides mechanisms and tools to easily communicate with remote targets.
ECHO builds on top of Google Protocol Buffers (Protobuf), which is
chosen because as a Google standard it already has wide adoption in the
world, with many programming languages being supported. Adding support
for new languages is simplified by Google thanks to its flexible
Protobuf compiler.</p>
</div>
<div class="paragraph">
<p>In this document, we assume familiarity with the concepts of Protobuf
such as its basic types, messages, and services. This document describes
the additions and restrictions on the Protobuf messages; the translation
from Protobuf services to a binary protocol; and running the compiler
plug-ins that generate C++, C# and Java code, which serves as an example
to write a Protobuf compiler plug-in for other languages.</p>
</div>
<div class="paragraph">
<p>The <code>.proto</code> files, which contain a description of all messages and
services, use the proto3 syntax. Information about Google Protocol
Buffers can be found at
<a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_protobuf_messages"><a class="anchor" href="#_protobuf_messages"></a>Protobuf Messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since ECHO builds on top of Protobuf, Google’s definition of messages
and translation of messages to a binary format is used. Protobuf defines
a mechanism to add options to messages, which is used by ECHO to place
upper limits on otherwise unbounded messages, so that on embedded
platforms a known amount of memory can be reserved for specific
messages.</p>
</div>
<div class="paragraph">
<p>For example, a message to hold a time zone locale (which has a maximum
length of 32) may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">message TimeLocale
{
    string timezone = 1 [(string_size) = 32];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Three entities in proto files are unbounded: fields of type string,
fields of type bytes, and repeated fields. The options describing their
upper limit are <code>string_size</code>, <code>bytes_size</code>, and <code>array_size</code>. Repeated
strings are defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">repeated string deviceUrls = 3 [(string_size) = 128, (array_size) = 2];</code></pre>
</div>
</div>
<div class="paragraph">
<p>The options <code>string_size</code>, <code>bytes_size</code>, and <code>array_size</code> are defined in
<code>EchoAttributes.proto</code>, which is part of this specification, and
attached as appendix.</p>
</div>
<div class="paragraph">
<p>Since in the generated embedded code these size attributes are used in
the definition of the fields of messages, the limits on these fields are
observed by design. Other languages/implementations may use
introspection mechanisms to ensure that the limits are observed, or they
may be made compliant by design; in any way, the limits may not be
surpassed, otherwise results of communication are unpredictable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_protobuf_services"><a class="anchor" href="#_protobuf_services"></a>Protobuf Services</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_conventions"><a class="anchor" href="#_conventions"></a>Conventions</h3>
<div class="paragraph">
<p>A service defined in Protobuf consist of a number of methods. Protobuf
does not define the encoding/decoding rules, so this document fully
defines this translation. Some RPC systems (like Google’s gRPC) use the
name of the services and methods to make the call. Since ECHO is
intended to be used in an embedded context, instead of using the names
of services and methods options are used to assign identifiers to
services and methods. Those options are defined in
<code>EchoAttributes.proto</code>, and are used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">service TestInteraction
{
    option (service_id) = 11;

    rpc Reset(Nothing) returns (Nothing) { option (method_id) = 1; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In ECHO, all messages are asynchronous. This is done for two reasons: 1)
Without having to wait for a response, a sender can send many messages
in quick succession, thereby fully utilizing network buffers. The
receiver can then pre-process the next message when still executing the
previous message; 2) Embedded applications without multiple threads
often have other (real time) tasks to accomplish. Having to wait for a
result of a message may complicate the execution model.</p>
</div>
<div class="paragraph">
<p>ECHO introduces a limitation on Protobuf interfaces: Since all messages
are assumed to be asynchronous, all messages must return <code>Nothing</code>.</p>
</div>
<div class="paragraph">
<p>All Protobuf methods take one message as parameter. When designing a
method with one or more parameters, a message is created containing
those parameters. When a method takes no data as input, the <code>Nothing</code>
type is used, which results in the generated code containing no
parameters (If a custom empty message would be used, generated methods
would take one parameter of that type, even though it contains no
fields). The <code>Reset</code> method in the example above therefore takes
<code>Nothing</code> as parameter, which results in generation of a <code>void Reset()</code>
function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_encoding_service_calls"><a class="anchor" href="#_encoding_service_calls"></a>Encoding Service Calls</h3>
<div class="paragraph">
<p>ECHO uses a reliable data stream to communicate, like TCP, so that
correct ordering and delivery is guaranteed until a disconnect occurs.
When a service’s method is invoked, the data is encoded as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">&lt;serviceId&gt; &lt;(methodId &lt;&lt; 3) | 2&gt; &lt;length&gt; &lt;message&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>serviceId</code>, adjusted <code>methodId</code>, and <code>length</code> are encoded as
Protobuf varints. The <code>methodId</code> is adjusted so that the combination of
<code>methodId</code>, <code>length</code>, and <code>message</code> is the same as a Protobuf field
where the <code>methodId</code> is the field number, and the <code>message</code> is the
contents. So it is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">&lt;serviceId&gt; &lt;field(methodId, message)&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>which is easier for some encoders/decoders.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_support_to_other_languages"><a class="anchor" href="#_adding_support_to_other_languages"></a>Adding Support to Other Languages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Google Protobuf compiler is able to generate code for a number of
languages, including C++, C#, Java, and Python. This generated code can
encode and decode the Protobuf messages defined in <code>.proto</code> files.
Support for ECHO communication using the services must be added on top
of that using a compiler plug-in. Such a compiler plug-in is written in
your favourite language, and it is invoked by the Protobuf compiler. It
is fed a Protobuf message on <code>stdin</code>, which completely defines the
interpreted <code>.proto</code> file, and on <code>stdout</code> the plug-in outputs a
Protobuf message which completely defines the resulting code. The
compiler takes care of the rest. This means that a compiler plug-in
immediately deals with an abstract syntax tree containing all
interpreted information about the <code>.proto</code> file, so that it can fully
focus on the form of the output, instead of on parsing the input.</p>
</div>
<div class="paragraph">
<p>If a language is targeted which is supported by the Protobuf compiler,
then the compiler plug-in for that language only needs to generate code
for the services, which consists of encoding and decoding services’
methods and their parameters. If an unsupported language is targeted,
then the compiler plug-in also has to generate code for encoding and
decoding the individual message.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_echoattributes_proto"><a class="anchor" href="#_appendix_echoattributes_proto"></a>Appendix: EchoAttributes.proto</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">syntax = "proto3";

option java_package = "com.philips.emil.protobufEcho";
option java_outer_classname = "EchoAttributesProto";

import "google/protobuf/descriptor.proto";

extend google.protobuf.FieldOptions {
  uint32 string_size = 50000;
  uint32 bytes_size = 50001;
  uint32 array_size = 50002;
}

extend google.protobuf.ServiceOptions {
  uint32 service_id = 50000;
}

extend google.protobuf.MethodOptions {
  uint32 method_id = 50000;
}

message Nothing {
}</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>© Koninklijke Philips N.V., 2022. All rights reserved.</p>
</footer>

<script type="text/javascript" src="../../_/js/medium-zoom.min.js"></script>
<script type="text/javascript">
mediumZoom('.data-zoomable img', {
  margin: 50,
  background: '#FFFFFFA1',
})
</script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
